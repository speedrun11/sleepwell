<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLEEPWELL - ADMIN DASHBOARD</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #4a90e2;
            --surface: #1a1a1a;
            --surface-light: #2d2d2d;
        }

        body {
            background: #121212;
            color: white;
            min-height: 100vh;
        }

        .navbar {
            background: var(--surface);
            height: 60px;
        }

        .sidebar {
            width: 300px;
            background: var(--surface);
            height: calc(100vh - 60px);
            padding: 20px;
            position: fixed;
        }

        .content {
            margin-left: 300px;
            padding: 30px;
            width: calc(100% - 300px);
        }

        .user-list {
            background: var(--surface-light);
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .user-list-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-list-item:hover {
            background: var(--surface-light);
        }

        .user-list-item.active {
            background: var(--primary);
            color: white;
        }

        .admin-actions {
            display: flex;
            gap: 8px;
        }

        .admin-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .export-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }

        .chart-container {
            background: var(--surface);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark px-4 fixed-top">
        <a class="navbar-brand" href="#">SleepWell Admin</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <span class="nav-link">
                        <i class="bi bi-shield-check"></i> Admin Mode
                    </span>
                </li>
                <li class="nav-item">
                    <button id="logout-btn" class="btn btn-outline-danger ms-2">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-info mb-4">
                <h5>Administrator Panel</h5>
                <small class="text-muted" id="admin-email">Loading admin...</small>
                <span class="admin-badge">Admin</span>
            </div>
            
            <div class="mb-3">
                <input type="text" class="form-control bg-dark text-light" placeholder="Search users..." id="user-search">
            </div>

            <div class="user-list" id="user-list">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading users...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="bg-primary rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="bi bi-shield-lock fs-4"></i>
                </div>
                <div>
                    <h2 class="mb-0">Admin Dashboard</h2>
                    <small class="text-muted">User Sleep Analysis Management</small>
                </div>
            </div>

            <div class="alert alert-info d-flex align-items-center" id="default-message">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>Select a user from the sidebar to view their sleep analysis data.</div>
            </div>

            <div id="user-details" style="display: none;">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>Sleep Duration Trends</h5>
                            <canvas id="durationChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>Sleep Quality Distribution</h5>
                            <div id="qualityChart"></div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h5 class="mb-4">Recent Sleep Entries</h5>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Duration</th>
                                    <th>Quality</th>
                                    <th>Bedtime</th>
                                    <th>Wake Time</th>
                                </tr>
                            </thead>
                            <tbody id="entries-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <button class="btn btn-success export-btn" id="export-data">
                <i class="bi bi-download"></i> Export Data
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration (Replace with your config)
        const firebaseConfig = {
            apiKey: "AIzaSyYOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abc123yourappid"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        db.settings({ experimentalForceLongPolling: true });

        let durationChartInstance = null;
        let qualityChartInstance = null;
        let selectedUserId = null;
        let usersUnsubscribe = null;

        // Utility functions
        function showAlert(message, type = "success") {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show fixed-top m-3`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        async function checkAdminStatus(user) {
            try {
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                return adminDoc.exists;
            } catch (error) {
                console.error("Admin check error:", error);
                return false;
            }
        }

        // User Management
        function setupRealTimeUsers() {
            usersUnsubscribe = db.collection('users').onSnapshot(snapshot => {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const userElement = document.createElement('div');
                    userElement.className = 'user-list-item';
                    userElement.id = `user-${doc.id}`;
                    userElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${userData.displayName || 'Anonymous User'}</strong><br>
                                <small class="text-muted">${userData.email}</small>
                            </div>
                            <div class="admin-actions">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${doc.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    userElement.onclick = () => loadUserData(doc.id);
                    userList.appendChild(userElement);
                });
            }, error => {
                console.error("User list error:", error);
                showAlert("Failed to load users", "danger");
            });
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user and all their data?')) return;
            
            try {
                // Delete user document
                await db.collection('users').doc(userId).delete();
                
                // Delete sleep entries
                const entries = await db.collection('sleepEntries')
                    .where('userId', '==', userId)
                    .get();
                
                const batch = db.batch();
                entries.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                showAlert("User deleted successfully", "success");
            } catch (error) {
                console.error("Delete error:", error);
                showAlert("Failed to delete user", "danger");
            }
        }

        // Data Loading
        async function loadUserData(userId) {
            try {
                selectedUserId = userId;
                document.getElementById('default-message').style.display = 'none';
                document.getElementById('user-details').style.display = 'block';

                // Load user profile
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();

                // Load sleep entries
                const entriesSnapshot = await db.collection('sleepEntries')
                    .where('userId', '==', userId)
                    .orderBy('date', 'desc')
                    .get();

                const entries = entriesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate()
                }));

                // Update table
                const tableBody = document.getElementById('entries-table');
                tableBody.innerHTML = entries.map(entry => `
                    <tr>
                        <td>${entry.date.toLocaleDateString()}</td>
                        <td>${entry.duration} hours</td>
                        <td>${entry.quality}/5</td>
                        <td>${entry.bedtime}</td>
                        <td>${entry.wakeTime}</td>
                    </tr>
                `).join('');

                // Update charts
                updateCharts(entries);
            } catch (error) {
                console.error("Load error:", error);
                showAlert("Failed to load user data", "danger");
            }
        }

        function updateCharts(entries) {
            // Destroy existing charts
            if (durationChartInstance) durationChartInstance.destroy();
            if (qualityChartInstance) qualityChartInstance.destroy();

            // Duration Chart (Chart.js)
            const durationCtx = document.getElementById('durationChart').getContext('2d');
            durationChartInstance = new Chart(durationCtx, {
                type: 'line',
                data: {
                    labels: entries.map(e => e.date.toLocaleDateString()),
                    datasets: [{
                        label: 'Sleep Duration (hours)',
                        data: entries.map(e => e.duration),
                        borderColor: '#4a90e2',
                        tension: 0.3
                    }]
                }
            });

            // Quality Chart (ApexCharts)
            const qualityData = [0, 0, 0, 0, 0];
            entries.forEach(e => qualityData[e.quality - 1]++);
            
            qualityChartInstance = new ApexCharts(document.getElementById('qualityChart'), {
                series: qualityData,
                chart: { type: 'donut' },
                labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                colors: ['#ff4560', '#feb019', '#00e396', '#008ffb', '#775dd0']
            });
            qualityChartInstance.render();
        }

        // Event Listeners
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
            window.location.href = '/admin.html';
        });

        document.getElementById('export-data').addEventListener('click', async () => {
            try {
                const entriesSnapshot = await db.collection('sleepEntries').get();
                const data = entriesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate().toISOString()
                }));
                
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sleepwell-export-${new Date().toISOString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Export error:", error);
                showAlert("Failed to export data", "danger");
            }
        });

        document.getElementById('user-search').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            document.querySelectorAll('.user-list-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'block' : 'none';
            });
        });

        // Auth State Listener
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = '/admin.html';
                return;
            }

            const isAdmin = await checkAdminStatus(user);
            if (!isAdmin) {
                auth.signOut();
                window.location.href = '/admin.html';
                return;
            }

            document.getElementById('admin-email').textContent = user.email;
            setupRealTimeUsers();
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (usersUnsubscribe) usersUnsubscribe();
            if (qualityChartInstance) qualityChartInstance.destroy();
            if (durationChartInstance) durationChartInstance.destroy();
        });
    </script>
</body>
</html>